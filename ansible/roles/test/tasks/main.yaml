- name: Check if resolv.conf has immutable attribute
  ansible.builtin.command: lsattr "/etc/resolv.conf"
  register: lsattr_result
  changed_when: false  # Не влияет на состояние системы
  ignore_errors: yes   # Игнорировать ошибки, если файла нет

- name: Remove immutable attribute (if set)
  ansible.builtin.command: chattr -i "/etc/resolv.conf"

- name: Get the first master node's IP
  ansible.builtin.set_fact:
    masters_ip: "{{ hostvars[groups['masters'][0]].ansible_default_ipv4.address }}"

- name: Debug masters_ip
  ansible.builtin.debug:
    var: masters_ip
  when: masters_ip is defined

- name: Replace nameserver entries
  ansible.builtin.command:
    cmd: sed -i 's/^nameserver\s\+\S\+/nameserver {{ masters_ip }}/g' /etc/resolv.conf

- name: Restore immutable attribute
  ansible.builtin.command: chattr +i "/etc/resolv.conf"